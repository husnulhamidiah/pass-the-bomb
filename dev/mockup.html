<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PTB</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
</head>

<body>
    <div class="container my-5">
        <div class="row">
            <div class="col-sm-5">
                <div class="card my-3">
                    <h7 class="card-header">screen :: home</h7>
                    <div class="card-body">
                        <input type="text" class="form-control mb-3" id="tb-home-roomid"
                            placeholder="insert gameroom id">
                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="handleJoinGame()">Join Game</a>
                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="handleCreateGame()">Create Game</a>
                    </div>
                </div>
                <div class="card my-3">
                    <h7 class="card-header">screen :: game</h7>
                    <div class="card-body">
                        <input type="text" class="form-control mb-1" id="tb-game-roomid" placeholder="gameroom id"
                            disabled>
                        <textarea class="form-control mb-3" id="tb-game-players" rows="3" disabled
                            placeholder="joined players"></textarea>
                        <textarea class="form-control mb-3" id="tb-game-log" rows="10" disabled
                            placeholder="game logs"></textarea>

                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="emitGameCreate()">Start</a>
                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="emitGameCreate()">Tap</a>
                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="emitGameJoin()">Pass</a>
                    </div>
                </div>
                <div class="card my-3">
                    <h7 class="card-header">screen :: final</h7>
                    <div class="card-body">
                        <a href="#" class="btn btn-block btn-primary mb-1" onclick="emitGameCreate()">OK</a>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const socket = io();

            const EVENT_UP_CREATE_GAME = 'up:game_create'
            const EVENT_UP_JOIN_GAME = 'up:game_join'
            const EVENT_UP_START_GAME = 'up:game_start'
            const EVENT_UP_GAME_TAP_BOMB = 'up:game_bomb_tap'
            const EVENT_UP_GAME_PASS_BOMB = 'up:game_bomb_pass'
            const EVENT_DOWN_PLAYER_JOINED = 'down:player_joined'
            const EVENT_DOWN_GAME_CREATED = 'down:game_created'
            const EVENT_DOWN_GAME_START = 'down:game_start'
            const EVENT_DOWN_GAME_END = 'down:game_end'
            const EVENT_DOWN_GAME_TURN_START = 'down:game_turn_start'
            const EVENT_DOWN_GAME_BOMB_TAP = 'down:game_bomb_tap'
            const EVENT_DOWN_GAME_BOMB_PASS = 'down:game_bomb_pass'

            // gamestates
            const gamestates = {
                roomid: '',
                playerid: '',
                isAdmin: '',
            }

            // aio handler
            var onevent = socket.onevent;
            socket.onevent = function (packet) {
                var args = packet.data || [];
                onevent.call(this, packet);    // original call
                packet.data = ["*"].concat(args);
                onevent.call(this, packet);      // additional call to catch-all
            };

            var subscribers = {} // map string to []function
            socket.on("*", function (event, data) {
                // debugger
                console.log(event, data);

                // run event waiters
                if (subscribers[event] && subscribers[event].length >= 1) {
                    const removables = []

                    // run fxs
                    subscribers[event].forEach((fx, i) => {
                        const isRemovable = fx(data)
                        if (isRemovable) removables.push(i)
                    });

                    // remove removable fxs
                    subscribers[event] = subscribers[event].filter((v, i) => {
                        return removables.indexOf(i) == -1
                    })
                }
            });

            // helper funcs
            var genid = function () {
                return '_' + Math.random().toString(36).substr(2, 9);
            };

            const publishEvent = (name, data) => {
                socket.emit(name, data)
                console.log(name, data);
            };

            const subscribeEvent = (name, callback) => {
                if (!subscribers[name]) subscribers[name] = []
                subscribers[name].push(callback)
            };

            // handlers
            function handleCreateGame() {
                if (gamestates.roomid) return

                const gameidbox = document.getElementById('tb-game-roomid');
                const playersbox = document.getElementById('tb-game-players');

                publishEvent(EVENT_UP_CREATE_GAME, { cid: genid() })

                subscribeEvent(EVENT_DOWN_GAME_CREATED, (data) => {
                    gamestates.roomid = data.roomid
                    gamestates.playerid = data.player.id
                    gamestates.isAdmin = data.player.isAdmin

                    gameidbox.value = data.roomid
                    playersbox.value = data.player.id

                    subscribeEvent(EVENT_DOWN_PLAYER_JOINED, (data) => {
                        playersbox.value = data.players.map(e => e.id).join('\n')
                    })

                    return true
                })
            }

            function handleJoinGame() {
                if (gamestates.roomid) return

                const cid = genid()
                const idbox = document.getElementById('tb-home-roomid');
                const gameidbox = document.getElementById('tb-game-roomid');
                const playersbox = document.getElementById('tb-game-players');

                const gameroomid = idbox.value
                publishEvent(EVENT_UP_JOIN_GAME, { cid, roomid: gameroomid })
                subscribeEvent(EVENT_DOWN_PLAYER_JOINED, (data) => {
                    if (data.cid != cid) return

                    gamestates.roomid = gameroomid
                    gamestates.playerid = data.player.id

                    gameidbox.value = gameroomid
                    playersbox.value = data.players.map(e => e.id).join('\n')

                    subscribeEvent(EVENT_DOWN_PLAYER_JOINED, (data) => {
                        playersbox.value = data.players.map(e => e.id).join('\n')
                    })

                    return true
                })
            }

        </script>
</body>

</html>